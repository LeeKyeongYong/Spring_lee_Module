<!DOCTYPE html>
<html layout:decorate="~{global/admLayout}">
<head>
    <title>팝업 등록</title>
    <script layout:fragment="script">
        document.getElementById('popupForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = new FormData(e.target);
            const popupData = {
                title: formData.get('title'),
                content: formData.get('content'),
                startDateTime: formData.get('startDateTime'),
                endDateTime: formData.get('endDateTime'),
                priority: parseInt(formData.get('priority')),
                width: parseInt(formData.get('width')),
                height: parseInt(formData.get('height')),
                positionX: parseInt(formData.get('positionX')),
                positionY: parseInt(formData.get('positionY')),
                linkUrl: formData.get('linkUrl'),
                altText: formData.get('altText'),
                target: formData.get('target'),
                deviceType: formData.get('deviceType'),
                cookieExpireDays: 1,
                hideForToday: formData.get('hideForToday') === 'on',
                hideForWeek: formData.get('hideForWeek') === 'on',
                maxDisplayCount: parseInt(formData.get('maxDisplayCount')) || 0,
                displayPages: [],
                targetRoles: []
            };

            const imageFile = formData.get('image');
            const finalFormData = new FormData();
            finalFormData.append('popup', new Blob([JSON.stringify(popupData)], {
                type: 'application/json'
            }));
            if (imageFile && imageFile.size > 0) {
                finalFormData.append('image', imageFile);
            }

            try {
                const response = await fetch('/api/popups', {
                    method: 'POST',
                    body: finalFormData
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || '팝업 생성에 실패했습니다.');
                }

                alert('팝업이 성공적으로 등록되었습니다.');
                window.location.href = '/adm/popups';
            } catch (error) {
                alert(error.message);
            }
        });
    </script>
</head>
<body>
    <div layout:fragment="content">
        <div class="container mx-auto px-4 py-8">
            <h1 class="text-2xl font-bold mb-6">팝업 등록</h1>

            <form id="popupForm" class="bg-white rounded-lg shadow p-6 space-y-6">
                <!-- 기본 정보 -->
                <div class="space-y-4">
                    <h2 class="text-lg font-semibold">기본 정보</h2>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">제목</label>
                        <input type="text" name="title" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">내용</label>
                        <textarea name="content" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></textarea>
                    </div>
                </div>

                <!-- 표시 기간 -->
                <div class="space-y-4">
                    <h2 class="text-lg font-semibold">표시 기간</h2>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">시작일시</label>
                            <input type="datetime-local" name="startDateTime" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">종료일시</label>
                            <input type="datetime-local" name="endDateTime" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                        </div>
                    </div>
                </div>

                <!-- 크기 및 위치 -->
                <div class="space-y-4">
                    <h2 class="text-lg font-semibold">크기 및 위치</h2>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">너비 (px)</label>
                            <input type="number" name="width" min="100" max="2000" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">높이 (px)</label>
                            <input type="number" name="height" min="100" max="2000" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">X 좌표</label>
                            <input type="number" name="positionX" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Y 좌표</label>
                            <input type="number" name="positionY" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                        </div>
                    </div>
                </div>

                <!-- 이미지 및 링크 -->
                <div class="space-y-4">
                    <h2 class="text-lg font-semibold">이미지 및 링크</h2>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">이미지</label>
                        <input type="file" name="image" accept="image/*" class="mt-1 block w-full">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">링크 URL</label>
                        <input type="url" name="linkUrl" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">대체 텍스트</label>
                        <input type="text" name="altText" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                    </div>
                </div>

                <!-- 표시 옵션 -->
                <div class="space-y-4">
                    <h2 class="text-lg font-semibold">표시 옵션</h2>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">디바이스 타입</label>
                            <select name="deviceType" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                <option value="ALL">모든 기기</option>
                                <option value="PC">PC</option>
                                <option value="MOBILE">모바일</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">링크 타겟</label>
                            <select name="target" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                <option value="SELF">현재 창</option>
                                <option value="BLANK">새 창</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- 추가 설정 -->
                <div class="space-y-4">
                    <h2 class="text-lg font-semibold">추가 설정</h2>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">우선순위</label>
                            <input type="number" name="priority" min="1" max="10" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">최대 노출 횟수</label>
                            <input type="number" name="maxDisplayCount" min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                        </div>
                    </div>
                    <div class="space-y-2">
                        <div class="flex items-center">
                            <input type="checkbox" name="hideForToday" class="rounded border-gray-300 text-blue-600 shadow-sm">
                            <label class="ml-2 text-sm text-gray-700">오늘 하루 보지 않기 허용</label>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" name="hideForWeek" class="rounded border-gray-300 text-blue-600 shadow-sm">
                            <label class="ml-2 text-sm text-gray-700">일주일 동안 보지 않기 허용</label>
                        </div>
                    </div>
                </div>

                <div class="flex justify-end space-x-4">
                    <button type="button" onclick="history.back()"
                            class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
                        취소
                    </button>
                    <button type="submit"
                            class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600">
                        등록
                    </button>
                </div>
            </form>
        </div>
    </div>
</body>
</html>