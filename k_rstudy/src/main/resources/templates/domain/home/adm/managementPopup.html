<!DOCTYPE html>
<html layout:decorate="~{global/admLayout}">
<head>
    <title>팝업 관리</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .preview-popup {
            position: fixed;
            display: none;
            z-index: 1000;
            background: white;
            box-shadow: 0 0 10px rgba(0,0,0,0.3);
        }
    </style>

    <script type="text/javascript">
        // 팝업 활성화/비활성화
        async function activatePopup(id) {
            try {
                await fetch(`/api/admin/popups/${id}/activate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                location.reload();
            } catch (error) {
                alert('팝업 활성화 중 오류가 발생했습니다.');
            }
        }

        async function deactivatePopup(id) {
            try {
                await fetch(`/api/admin/popups/${id}/deactivate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                location.reload();
            } catch (error) {
                alert('팝업 비활성화 중 오류가 발생했습니다.');
            }
        }

        // 팝업 미리보기
        async function previewPopup(id) {
            try {
                const response = await fetch(`/api/admin/popups/${id}/preview`);
                const data = await response.json();

                const previewPopup = document.getElementById('preview-popup');
                previewPopup.style.width = data.width + 'px';
                previewPopup.style.height = data.height + 'px';
                previewPopup.style.display = 'block';
                previewPopup.querySelector('.preview-content').innerHTML = data.content;

                // 드래그 가능하도록 설정
                makeDraggable(previewPopup);
            } catch (error) {
                alert('미리보기를 불러오는 중 오류가 발생했습니다.');
            }
        }

        // 통계 차트 표시
        async function showStatistics(id) {
            try {
                const response = await fetch(`/api/admin/popups/${id}/statistics`);
                const data = await response.json();

                // 디바이스별 통계 차트
                new Chart(document.getElementById('deviceChart'), {
                    type: 'pie',
                    data: {
                        labels: Object.keys(data.deviceStats),
                        datasets: [{
                            data: Object.values(data.deviceStats),
                            backgroundColor: ['#4B5563', '#60A5FA', '#34D399']
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: {
                                display: true,
                                text: '디바이스별 통계'
                            }
                        }
                    }
                });

                // 닫기 방식 통계 차트
                new Chart(document.getElementById('closeTypeChart'), {
                    type: 'pie',
                    data: {
                        labels: Object.keys(data.closeTypeStats),
                        datasets: [{
                            data: Object.values(data.closeTypeStats),
                            backgroundColor: ['#F87171', '#FBBF24', '#818CF8']
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: {
                                display: true,
                                text: '닫기 방식 통계'
                            }
                        }
                    }
                });

                document.getElementById('statistics-modal').classList.remove('hidden');
            } catch (error) {
                alert('통계를 불러오는 중 오류가 발생했습니다.');
            }
        }

        // 팝업 복제
        async function clonePopup(id) {
            if (!confirm('팝업을 복제하시겠습니까?')) return;

            try {
                const response = await fetch(`/api/admin/popups/${id}/clone`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                location.reload();
            } catch (error) {
                alert('팝업 복제 중 오류가 발생했습니다.');
            }
        }

        // 팝업 삭제
        async function deletePopup(id) {
            if (!confirm('정말 삭제하시겠습니까?')) return;

            try {
                await fetch(`/api/admin/popups/${id}`, {
                    method: 'DELETE'
                });
                document.getElementById(`popup-row-${id}`).remove();
            } catch (error) {
                alert('팝업 삭제 중 오류가 발생했습니다.');
            }
        }

        // 드래그 가능한 팝업
        function makeDraggable(element) {
            let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
            element.onmousedown = dragMouseDown;

            function dragMouseDown(e) {
                e = e || window.event;
                e.preventDefault();
                pos3 = e.clientX;
                pos4 = e.clientY;
                document.onmouseup = closeDragElement;
                document.onmousemove = elementDrag;
            }

            function elementDrag(e) {
                e = e || window.event;
                e.preventDefault();
                pos1 = pos3 - e.clientX;
                pos2 = pos4 - e.clientY;
                pos3 = e.clientX;
                pos4 = e.clientY;
                element.style.top = (element.offsetTop - pos2) + "px";
                element.style.left = (element.offsetLeft - pos1) + "px";
            }

            function closeDragElement() {
                document.onmouseup = null;
                document.onmousemove = null;
            }
        }
    </script>
</head>
    <body>
        <div layout:fragment="content">
            <div class="container mx-auto px-4 py-8">
                <!-- 상단 메뉴 -->
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-2xl font-bold">팝업 관리</h1>
                    <div class="space-x-2">
                        <a th:href="@{/adm/popups/templates}"
                           class="bg-green-500 text-white px-4 py-2 rounded">
                            템플릿 관리
                        </a>
                        <a th:href="@{/adm/popups/create}"
                           class="bg-blue-500 text-white px-4 py-2 rounded">
                            새 팝업 등록
                        </a>
                    </div>
                </div>

                <!-- 팝업 목록 -->
                <div class="bg-white rounded-lg shadow overflow-hidden">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                                제목/이미지
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                                상태/기간
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                                통계
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                                관리
                            </th>
                        </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
                        <tr th:each="popup : ${popups}" th:id="'popup-row-' + ${popup.id}">
                            <td class="px-6 py-4">
                                <div class="flex items-center">
                                    <img th:if="${popup.imageUrl}"
                                         th:src="${popup.imageUrl}"
                                         class="h-16 w-16 object-cover mr-3">
                                    <div>
                                        <div class="font-medium" th:text="${popup.title}"></div>
                                        <div class="text-sm text-gray-500">
                                            <span th:text="${popup.deviceType}"></span>
                                            <span th:if="${popup.repeatType}"
                                                  th:text="'(' + ${popup.repeatType} + ')'">
                                                </span>
                                        </div>
                                    </div>
                                </div>
                            </td>
                            <td class="px-6 py-4">
                                <div class="mb-2">
                                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full"
                                              th:classappend="${popup.status == 'ACTIVE' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}"
                                              th:text="${popup.status}">
                                        </span>
                                    <button th:if="${popup.status == 'INACTIVE'}"
                                            th:onclick="'activatePopup(' + ${popup.id} + ')'"
                                            class="ml-2 text-xs text-blue-600 hover:text-blue-900">
                                        활성화
                                    </button>
                                    <button th:if="${popup.status == 'ACTIVE'}"
                                            th:onclick="'deactivatePopup(' + ${popup.id} + ')'"
                                            class="ml-2 text-xs text-red-600 hover:text-red-900">
                                        비활성화
                                    </button>
                                </div>
                                <div class="text-sm text-gray-500">
                                    <div th:text="${#temporals.format(popup.startDateTime, 'yyyy-MM-dd HH:mm')}"></div>
                                    <div th:text="${#temporals.format(popup.endDateTime, 'yyyy-MM-dd HH:mm')}"></div>
                                </div>
                            </td>
                            <td class="px-6 py-4">
                                <div class="text-sm">
                                    <div>노출수: <span th:text="${popup.statistics.viewCount}"></span></div>
                                    <div>클릭률: <span th:text="${#numbers.formatDecimal(popup.statistics.ctr, 1, 2)}">%</span></div>
                                    <button class="text-blue-600 hover:text-blue-900 text-xs"
                                            th:onclick="'showStatistics(' + ${popup.id} + ')'">
                                        상세 통계
                                    </button>
                                </div>
                            </td>
                            <td class="px-6 py-4">
                                <div class="space-y-2">
                                    <button class="block text-blue-600 hover:text-blue-900"
                                            th:onclick="'previewPopup(' + ${popup.id} + ')'">
                                        미리보기
                                    </button>
                                    <a th:href="@{/adm/popups/edit/{id}(id=${popup.id})}"
                                       class="block text-blue-600 hover:text-blue-900">
                                        수정
                                    </a>
                                    <button class="block text-blue-600 hover:text-blue-900"
                                            th:onclick="'clonePopup(' + ${popup.id} + ')'">
                                        복제
                                    </button>
                                    <button class="block text-red-600 hover:text-red-900"
                                            th:onclick="'deletePopup(' + ${popup.id} + ')'">
                                        삭제
                                    </button>
                                </div>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- 통계 모달 -->
            <div id="statistics-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden">
                <div class="bg-white rounded-lg p-8 max-w-2xl mx-auto mt-20">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold">상세 통계</h2>
                        <button onclick="closeStatisticsModal()" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <canvas id="deviceChart"></canvas>
                        </div>
                        <div>
                            <canvas id="closeTypeChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 미리보기 팝업 -->
            <div id="preview-popup" class="preview-popup">
                <div class="preview-content"></div>
            </div>
        </div>

    </body>
</html>