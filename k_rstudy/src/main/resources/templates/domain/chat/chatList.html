<!DOCTYPE html>
<html layout:decorate="~{global/usrLayout}" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<head>
    <script th:inline="javascript">
        /*<![CDATA[*/
        function loadChatRooms() {
            fetch("/api/v1/chat/rooms")
                .then(response => {
                    const contentType = response.headers.get("content-type");
                    if (contentType && contentType.includes("application/json")) {
                        return response.json();
                    }
                    throw new TypeError("서버에서 JSON이 아닌 다른 데이터를 반환했습니다.");
                })
                .then(data => {
                    data.reverse();
                    renderChatRooms(data);
                })
                .catch(error => {
                    console.error("Error:", error);
                });
        }

        function renderChatRooms(chatRooms) {
            const chatRoomList = document.getElementById("chat-room-list");
            chatRoomList.innerHTML = chatRooms.map(chatRoom => `
                <li class="flex gap-2 items-center my-2">
                    <span>${chatRoom.id}번방</span>
                    <a href='/chat/rooms/${chatRoom.id}' class="text-blue-500 hover:underline">${chatRoom.roomName}</a>
                    <span>${dateForPrint(chatRoom.createDate)}</span>
                </li>
            `).join('');
        }

        function dateForPrint(date) {
            return date.substring(2, 16).replaceAll("-", ".").replace("T", " ");
        }

        function submitAddChatRoom(e) {
            e.preventDefault();

            const form = e.target;
            const roomNameInput = document.getElementById("chat-room-name");
            const roomName = roomNameInput.value.trim();

            if (roomName.length == 0) {
                alert("채팅방 이름을 입력해주세요.");
                roomNameInput.focus();
                return;
            }

            fetch("/api/v1/chat/rooms", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    roomName: roomName
                })
            })
                .then(response => response.json())
                .then(data => {
                    console.log(`${data.id}번 채팅방이 생성되었습니다.`);
                    roomNameInput.value = "";
                    loadChatRooms();  // 목록 새로고침
                })
                .catch(error => {
                    console.error("Error:", error);
                    alert("채팅방 생성에 실패했습니다.");
                });
        }

        // 페이지 로드 시 채팅방 목록 불러오기
        document.addEventListener("DOMContentLoaded", function() {
            loadChatRooms();
            setInterval(loadChatRooms, 3000);  // 3초마다 목록 갱신
        });
        /*]]>*/
    </script>
</head>
<body>
<div layout:fragment="content" class="container mx-auto p-4">
    <h1 class="font-bold text-lg mb-4">채팅방 생성</h1>

    <form onsubmit="submitAddChatRoom(event)" class="flex gap-2 mb-4">
        <input
                id="chat-room-name"
                type="text"
                placeholder="채팅방 이름"
                class="border rounded p-2 flex-grow"
                autocomplete="off"
        >
        <input
                type="submit"
                value="채팅방 생성"
                class="border rounded p-2 hover:bg-gray-100 cursor-pointer"
        >
    </form>

    <hr class="my-4">

    <h1 class="font-bold text-lg mb-4">채팅방 목록</h1>
    <ul id="chat-room-list" class="space-y-2"></ul>
</div>
</body>
</html>