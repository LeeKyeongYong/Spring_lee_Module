<!DOCTYPE html>
<html layout:decorate="~{global/usrLayout}" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<head>
    <style>
        .font-bold { font-weight: bold; }
        .text-lg { font-size: 1.125rem; }
        .mt-2 { margin-top: 0.5rem; }
        .my-2 { margin-top: 0.5rem; margin-bottom: 0.5rem; }
        .flex { display: flex; }
        .gap-2 { gap: 0.5rem; }
        .border { border: 1px solid #ccc; }
        .p-2 { padding: 0.5rem; }
        .w-20 { width: 5rem; }
        .flex-grow { flex-grow: 1; }
        .cursor-pointer { cursor: pointer; }
        .hover\:bg-gray-100:hover { background-color: #f3f4f6; }
    </style>
    <script th:inline="javascript">
        /*<![CDATA[*/
        const chatRoomId = [[${chatRoom.id}]];
        let lastChatMessageId = 0;
        let chatMessages = [];

        function loadMoreChatMessages() {
            fetch(`/api/v1/chat/rooms/${chatRoomId}/messages?afterChatMessageId=${lastChatMessageId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.length > 0) {
                        data.reverse();
                        lastChatMessageId = data[0].id;
                        chatMessages = [...data, ...chatMessages];
                        renderChatMessages();
                    }
                });
        }

        function renderChatMessages() {
            const chatMessagesList = document.getElementById("chat-messages-list");
            chatMessagesList.innerHTML = chatMessages.map(chatMessage => `
                <li>
                    ${chatMessage.id}(${dateForPrint(chatMessage.createDate)}) :
                    ${chatMessage.writerName} : ${chatMessage.content}
                </li>
            `).join('');
        }

        function dateForPrint(date) {
            return date.substring(2, 16).replaceAll("-", ".").replace("T", " ");
        }

        function onChatMessageFormSubmit() {
            const writerNameInput = document.querySelector('input[name="writerName"]');
            const contentInput = document.querySelector('input[name="content"]');

            const writerName = writerNameInput.value.trim();
            const content = contentInput.value.trim();

            if (writerName.length === 0) {
                alert("작성자를 입력해주세요.");
                writerNameInput.focus();
                return;
            }

            if (content.length === 0) {
                alert("메세지를 입력해주세요.");
                contentInput.focus();
                return;
            }

            contentInput.value = "";
            contentInput.focus();

            fetch(`/api/v1/chat/rooms/${chatRoomId}/messages`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    writerName,
                    content
                })
            })
                .then(response => response.json())
                .then(data => {
                    console.log(`${data.id}번 메세지가 작성되었습니다.`);
                    loadMoreChatMessages();
                });
        }

        document.addEventListener("DOMContentLoaded", function() {
            loadMoreChatMessages();
            setInterval(loadMoreChatMessages, 1000);
        });
        /*]]>*/
    </script>
</head>
<body>
<div layout:fragment="content">
    <h1 class="font-bold text-lg">
        채팅방(No <span th:text="${chatRoom.id}"></span> :
        <span th:text="${chatRoom.roomName}"></span>)
    </h1>
    <div class="mt-2">
        개설날짜 : <span th:text="${#temporals.format(chatRoom.createDate, 'yy.MM.dd HH:mm')}"></span>
    </div>

    <hr class="my-2"/>

    <h1 class="font-bold text-lg">채팅 메세지 작성</h1>

    <div class="flex gap-2">
        <div class="flex gap-2 flex-grow">
            <input
                    class="border p-2 w-20"
                    type="text"
                    placeholder="작성자"
                    name="writerName"
                    autocomplete="off"
            />
            <input
                    class="border p-2 flex-grow"
                    type="text"
                    placeholder="메세지"
                    name="content"
                    autocomplete="off"
            />
            <button
                    class="border p-2 cursor-pointer hover:bg-gray-100"
                    onclick="onChatMessageFormSubmit()"
            >
                작성
            </button>
        </div>
        <a href="/chat/rooms" class="border p-2 cursor-pointer hover:bg-gray-100">
            나가기
        </a>
    </div>

    <hr class="my-2"/>

    <h1 class="font-bold text-lg">채팅 메세지</h1>

    <ul id="chat-messages-list"></ul>
</div>
</body>
</html>