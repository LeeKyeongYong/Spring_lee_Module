<html layout:decorate="~{global/msgLayout}">

<head>
    <title>메세지 보내기</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* 기본 스타일 설정 */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #f5f5f5;
        }

        /* 컨테이너 스타일 */
        .container {
            display: grid;
            grid-template-columns: 300px 1fr; /* 좌측 패널과 우측 패널 비율 */
            height: 100vh;
            max-width: 1600px;
            margin: 0 auto;
            background-color: white;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }

        /* 좌측 메시지 목록 패널 스타일 */
        .message-list-panel {
            border-right: 1px solid #e0e0e0; /* 경계선 */
            background-color: #fff;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .message-list-header {
            padding: 15px;
            border-bottom: 1px solid #e0e0e0; /* 경계선 */
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .unread-count {
            background-color: #f44336; /* 빨간색 배경 */
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
        }

        .message-list {
            overflow-y: auto; /* 세로 스크롤 */
            flex: 1;
        }

        /* 메시지 아이템 스타일 */
        .message-item {
            padding: 15px 20px;
            border-bottom: 1px solid #f0f0f0; /* 경계선 */
            cursor: pointer; /* 커서 모양 변경 */
            transition: background-color 0.2s; /* 배경색 변경 시 부드러운 전환 효과 */
        }

        .message-item:hover {
            background-color: #f8f9fa; /* 호버 시 배경색 변경 */
        }

        .message-item.unread {
            background-color: #e3f2fd; /* 읽지 않은 메시지 배경색 */
        }

        .message-item-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .sender-name {
            font-weight: bold; /* 굵은 글씨 */
        }

        .message-time {
            color: #666; /* 회색 글씨 */
            font-size: 12px;
        }

        .message-preview {
            color: #666; /* 회색 글씨 */
            white-space: nowrap; /* 줄 바꿈 방지 */
            overflow: hidden; /* 넘치는 내용 숨김 */
            text-overflow: ellipsis; /* 넘치는 내용 생략 부호 추가 */
        }

        /* 우측 메시지 상세 패널 스타일 */
        .message-detail-panel {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .message-detail-header {
            padding: 20px;
            border-bottom: 1px solid #e0e0e0; /* 경계선 */
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .message-detail-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto; /* 세로 스크롤 */
        }

        .message-compose {
            padding: 20px;
            border-top: 1px solid #e0e0e0; /* 경계선 */
        }

        /* 메시지 작성 영역 스타일 */
        .compose-header {
            display: flex;
            margin-bottom: 10px;
            align-items: center;
        }

        .recipient-container {
            flex: 1;
            min-height: 38px;
            border: 1px solid #e0e0e0; /* 경계선 */
            border-radius: 4px; /* 둥근 모서리 */
            padding: 5px;
            margin-right: 10px;
            display: flex;
            flex-wrap: wrap; /* 내용이 넘칠 경우 줄 바꿈 */
            gap: 5px; /* 간격 */
        }

        .recipient-tag {
            background-color: #e3f2fd; /* 연한 파란색 배경 */
            padding: 3px 8px;
            border-radius: 16px; /* 둥근 태그 */
            font-size: 14px;
            display: flex;
            align-items: center;
        }

        .recipient-tag .remove {
            margin-left: 5px;
            cursor: pointer; /* 커서 모양 변경 */
        }

        .search-recipient-btn {
            padding: 8px 16px;
            background-color: #1976d2; /* 파란색 배경 */
            color: white;
            border: none;
            border-radius: 4px; /* 둥근 모서리 */
            cursor: pointer; /* 커서 모양 변경 */
        }

        .message-input {
            width: 100%; /* 가로폭 100% */
            min-height: 100px; /* 최소 높이 */
            padding: 10px; /* 여백 */
            border: 1px solid #e0e0e0; /* 경계선 */
            border-radius: 4px; /* 둥근 모서리 */
            resize: vertical; /* 수직으로 크기 조절 가능 */
            margin-bottom: 10px;
        }

        .send-button {
            padding: 10px 20px;
            background-color: #1976d2; /* 파란색 배경 */
            color: white;
            border: none;
            border-radius: 4px; /* 둥근 모서리 */
            cursor: pointer; /* 커서 모양 변경 */
            float: right; /* 오른쪽 정렬 */
        }

        /* 모달 스타일 */
        .modal {
            display: none;
            position: fixed; /* 고정 위치 */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5); /* 반투명 배경 */
            z-index: 1000; /* 최상위 레이어 */
        }

        .modal-content {
            position: relative;
            background-color: white;
            width: 90%;
            max-width: 600px; /* 최대 너비 */
            margin: 50px auto; /* 중앙 정렬 */
            padding: 20px; /* 여백 */
            border-radius: 8px; /* 둥근 모서리 */
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); /* 그림자 효과 */
        }

        .modal-header {
            margin-bottom: 20px;
        }

        .modal-header h2 {
            margin: 0; /* 여백 제거 */
        }

        .search-input {
            width: 100%; /* 가로폭 100% */
            padding: 10px; /* 여백 */
            border: 1px solid #e0e0e0; /* 경계선 */
            border-radius: 4px; /* 둥근 모서리 */
            margin-bottom: 20px;
        }

        .search-results {
            max-height: 300px; /* 최대 높이 */
            overflow-y: auto; /* 세로 스크롤 */
        }

        .user-item {
            padding: 10px; /* 여백 */
            border-bottom: 1px solid #f0f0f0; /* 경계선 */
            cursor: pointer; /* 커서 모양 변경 */
            display: flex;
            justify-content: space-between; /* 공간을 양쪽에 분배 */
            align-items: center; /* 수직 가운데 정렬 */
        }

        .user-item:hover {
            background-color: #f5f5f5; /* 호버 시 배경색 변경 */
        }

        .user-info {
            display: flex; /* 유저 정보 영역 */
            gap: 10px; /* 간격 */
            align-items: center; /* 수직 가운데 정렬 */
        }

        .department-info {
            color: #666; /* 회색 글씨 */
            font-size: 14px;
        }

        .modal-footer {
            margin-top: 20px;
            text-align: right;
            gap: 10px; /* 간격 */
            display: flex; /* 플렉스 박스 사용 */
            justify-content: flex-end; /* 오른쪽 정렬 */
        }

        .modal-button {
            padding: 8px 16px; /* 여백 */
            border-radius: 4px; /* 둥근 모서리 */
            cursor: pointer; /* 커서 모양 변경 */
        }

        .modal-button.cancel {
            background-color: #e0e0e0; /* 회색 배경 */
            color: black; /* 검은색 글씨 */
        }

        .modal-button.confirm {
            background-color: #1976d2; /* 파란색 배경 */
            color: white; /* 흰색 글씨 */
        }

        /* 반응형 디자인을 위한 미디어 쿼리 */
        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr; /* 모바일 환경에서 열을 하나로 변경 */
            }
        }

        /* 메시지 항목 선택 상태 스타일 */
        .message-item.selected {
            background-color: #ffffff;
            border-left: 3px solid #1976d2;
        }

        /* 메시지 상세 내용 스타일 */
        .message-detail {
            padding: 20px;
        }

        .message-detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e0e0e0;
        }

        .message-detail-header h4 {
            margin: 0;
            font-size: 18px;
        }

        .message-body {
            line-height: 1.6;
            color: #333;
        }

        .pagination {
            justify-content: center !important; /* 페이징 가운데 정렬 */
            margin-top: 20px;
        }

        .no-messages {
            padding: 20px;
            text-align: center;
            color: #666;
            font-style: italic;
        }

    </style>
    <script>
        let selectedRecipients = new Set();
        let allSearchResults = [];
        let currentPage = 1;
        const itemsPerPage = 10;

        // 전역 변수로 현재 읽지 않은 메시지 수를 관리
        let unreadCount = 3;

        function openRecipientModal(event) {
            if (event) {
                event.preventDefault();
            }
            document.getElementById('recipientModal').style.display = 'block';
            searchRecipients();
        }

        function closeRecipientModal() {
            document.getElementById('recipientModal').style.display = 'none';
        }



        async function searchRecipients() {
            const searchValue = document.getElementById('searchInput').value;

            try {
                // 검색 시 항상 첫 페이지로 리셋
                currentPage = 1;

                const response = await fetch(`/api/messages/search-users?searchUsername=${encodeURIComponent(searchValue)}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }

                const data = await response.json();
                console.log('Search results:', data);

                if (!Array.isArray(data)) {
                    throw new Error('Invalid data structure');
                }

                allSearchResults = data; // 전체 검색 결과 저장
                const totalPages = Math.ceil(allSearchResults.length / itemsPerPage) || 1;

                displaySearchResults(currentPage);
                updatePagination(totalPages);

            } catch (error) {
                console.error('Error:', error);
                document.querySelector('.no-results').textContent = '사용자 검색 중 오류가 발생했습니다.';
                document.querySelector('.no-results').style.display = 'block';
                document.querySelector('.pagination').style.display = 'none';
            }
        }

        function displaySearchResults(page) {
            const tbody = document.getElementById('recipientList');
            tbody.innerHTML = ''; // 이전 검색 결과 초기화

            const startIndex = (page - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const usersToDisplay = allSearchResults.slice(startIndex, endIndex);

            if (usersToDisplay.length === 0) {
                document.querySelector('.no-results').style.display = 'block';
                document.querySelector('.pagination').style.display = 'none';
            } else {
                document.querySelector('.no-results').style.display = 'none';
                document.querySelector('.pagination').style.display = 'flex';

                usersToDisplay.forEach((user, index) => {
                    const row = `
                <tr>
                    <td>${startIndex + index + 1}</td>
                    <td>${user.name}</td>
                    <td>
                        <button class="btn btn-sm btn-primary"
                            onclick="selectRecipient('${user.id}', '${user.name}', '${user.userid}')">
                            선택
                        </button>
                    </td>
                </tr>
            `;
                    tbody.insertAdjacentHTML('beforeend', row);
                });
            }
        }

        function updatePagination(totalPages) {
            const paginationElement = document.querySelector('.pagination');
            paginationElement.innerHTML = '';

            // 이전 페이지 버튼
            if (currentPage > 1) {
                paginationElement.innerHTML += `
            <li class="page-item">
                <a class="page-link" href="#" onclick="changePage(${currentPage - 1})">이전</a>
            </li>
        `;
            }

            // 페이지 번호
            for (let i = 1; i <= totalPages; i++) {
                paginationElement.innerHTML += `
            <li class="page-item ${i === currentPage ? 'active' : ''}">
                <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
            </li>
        `;
            }

            // 다음 페이지 버튼
            if (currentPage < totalPages) {
                paginationElement.innerHTML += `
            <li class="page-item">
                <a class="page-link" href="#" onclick="changePage(${currentPage + 1})">다음</a>
            </li>
        `;
            }
        }


        function changePage(page) {
            currentPage = page;
            displaySearchResults(page);
            updatePagination(Math.ceil(allSearchResults.length / itemsPerPage));
            return false; // 이벤트 기본 동작 방지
        }

        function selectRecipient(id, name,userid) {
            // 새로운 수신자를 Set에 추가
            const recipientId = parseInt(id, 10);
            if (isNaN(recipientId)) {
                console.error('Invalid ID format');
                return;
            }

            selectedRecipients.add({
                id: recipientId,  // 숫자로 변환된 ID 사용
                name: name,
                userid: userid
            });

            // 화면 업데이트
            updateRecipientDisplay();

            // 모달 닫기
            closeRecipientModal();
        }

        function removeRecipient(id) {
            // Set에서 해당 수신자 제거
            selectedRecipients.delete([...selectedRecipients].find(r => r.id === id));

            // 화면 업데이트
            updateRecipientDisplay();
        }

        function updateRecipientDisplay() {
            const container = document.querySelector('.recipient-container');
            container.innerHTML = '';

            selectedRecipients.forEach(recipient => {
                const tagHtml = `
            <div class="recipient-tag" data-id="${recipient.id}">
                ${recipient.name} (${recipient.userid})
                <span class="remove" onclick="removeRecipient('${recipient.id}')">×</span>
            </div>
        `;
                container.insertAdjacentHTML('beforeend', tagHtml);
            });
        }

        function validateAndSubmit() {
            if (selectedRecipients.size === 0) {
                alert('받는 사람을 선택해주세요.');
                return false;
            }



            const titleInput = document.getElementById('titleInput');
            if (!titleInput || !titleInput.value.trim()) {
                alert('제목을 입력해주세요.');
                return false;
            }

            const contentElement = document.querySelector('.message-input');
            if (!contentElement || !contentElement.value.trim()) {
                alert('내용을 입력해주세요.');
                return false;
            }
            document.getElementById('recipientsInput').value = JSON.stringify(Array.from(selectedRecipients));
            return true;

        }

        // 메시지 데이터 예시 (실제로는 서버에서 가져와야 함)
        const messageData = {};

        // DOM이 로드된 후 이벤트 리스너 설정
        document.addEventListener('DOMContentLoaded', () => {

            // searchInput 요소가 있을 때만 이벤트 리스너 추가
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                // 디바운스 적용하여 검색 수행
                searchInput.addEventListener('input', debounce(() => {
                    searchRecipients();
                }, 300));
            }

            // 초기 메시지 목록 표시
            displayMessageList();

            // 초기 읽지 않은 메시지 수 표시
            updateUnreadCount();

            // 초기 수신자 목록 표시 (비어있음)
            //updateRecipientDisplay();

            // 이벤트 위임을 사용하여 수신자 태그 삭제 처리
            document.querySelector('.recipient-container').addEventListener('click', function(e) {
                if (e.target.classList.contains('remove')) {
                    const recipientTag = e.target.closest('.recipient-tag');
                    if (recipientTag) {
                        const recipientId = recipientTag.dataset.id;
                        removeRecipient(recipientId);
                    }
                }
            });

            // 폼 제출 이벤트 처리
            document.getElementById('messageForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                if (validateAndSubmit()) {
                    const content = document.querySelector('.message-input').value;
                    const titleInput = document.getElementById('titleInput').value;
                    const recipients = Array.from(selectedRecipients).map(recipient => ({
                        recipientId: recipient.id, // 이미 숫자 타입
                        recipientName: recipient.name,
                        recipientUserId: recipient.userid
                    }));

                    try {
                        const response = await fetch('/api/messages/save', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRF-TOKEN': document.querySelector('[name="_csrf"]').value
                            },
                            body: JSON.stringify({
                                content: content,
                                title:titleInput,
                                recipients: recipients
                            })
                        });

                        if (!response.ok) {
                            throw new Error('메시지 전송 실패');
                        }

                        alert('메시지가 성공적으로 전송되었습니다.');
                        document.querySelector('.message-input').value = '';
                        document.getElementById('titleInput').value='';
                        selectedRecipients.clear();
                        updateRecipientDisplay();
                        displayMessageList();

                    } catch (error) {
                        console.error('Error:', error);
                        alert('메시지 전송 중 오류가 발생했습니다.');
                    }
                }
            });


        });

        function debounce(func, delay) {
            let timeout;
            return function (...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), delay);
            };
        }

        function displayMessageList() {
            const messageList = document.querySelector('.message-list');
            messageList.innerHTML = '';

            if (Object.keys(messageData).length === 0) {
                // 메시지가 없을 때
                const noMessageElement = document.createElement('div');
                noMessageElement.className = 'no-messages';
                noMessageElement.textContent = '받은 메시지가 존재하지 않습니다.';
                messageList.appendChild(noMessageElement);
            } else {
                for (const [id, message] of Object.entries(messageData)) {
                    const messageItem = document.createElement('div');
                    messageItem.className = `message-item ${message.isUnread ? 'unread' : ''}`;
                    messageItem.setAttribute('data-message-id', id);
                    messageItem.innerHTML = `
                        <div class="message-item-header">
                            <span class="sender-name">${message.sender}</span>
                            <span class="message-time">${message.time}</span>
                        </div>
                        <div class="message-preview">${message.preview}</div>
                    `;
                    messageItem.addEventListener('click', () => handleMessageClick(id));
                    messageList.appendChild(messageItem);
                }
            }
            updateUnreadCount();
        }

        function handleMessageClick(messageId) {
            const messageItem = document.querySelector(`[data-message-id="${messageId}"]`);
            const message = messageData[messageId];

            if (message.isUnread) {
                message.isUnread = false;
                messageItem.classList.remove('unread');
                unreadCount--;
                updateUnreadCount();
            }

            // 모든 메시지 항목의 선택 상태 제거
            document.querySelectorAll('.message-item').forEach(item => {
                item.classList.remove('selected');
            });

            // 클릭된 메시지 항목 선택 상태로 변경
            messageItem.classList.add('selected');

            showMessageDetail(messageId);
        }

        function updateUnreadCount() {
            fetch('/api/messages/unread-count')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    const unreadCountSpan = document.getElementById('unreadCountSpan');
                    unreadCountSpan.textContent = data.count;
                    unreadCountSpan.style.display = data.count > 0 ? 'inline-block' : 'none';
                })
                .catch(error => console.error('안 읽은 메시지 수 가져오기 오류:', error));
        }

        function showMessageDetail(messageId) {
            const message = messageData[messageId];
            const detailContent = document.querySelector('.message-detail-content');

            // 새 메시지 작성 폼을 메시지 상세 내용으로 교체
            detailContent.innerHTML = `
        <div class="message-detail">
            <div class="message-detail-header">
                <h4>${message.sender}</h4>
                <span class="message-time">${message.time}</span>
            </div>
            <div class="message-body">
                <pre style="white-space: pre-wrap; font-family: inherit;">${message.content}</pre>
            </div>
        </div>
    `;
        }

        function getUrlParams() {
            const params = new URLSearchParams(window.location.search);
            return Object.fromEntries(params);
        }

    </script>
</head>

<body>
    <div layout:fragment="content">
        <div class="container">
            <!-- 좌측 메시지 목록 패널 -->
            <div class="message-list-panel">
                <div class="message-list-header">
                    <h2>받은 메세지함.</h2>
                    <span class="unread-count" id="unreadCountSpan">3</span>
                </div>
                <div class="message-list">
                    <div class="message-item unread">
                        <div class="message-item-header">
                            <span class="sender-name">홍길동</span>
                            <span class="message-time">10:30</span>
                        </div>
                        <div class="message-preview">
                            안녕하세요. 프로젝트 관련해서 문의드립니다.
                        </div>
                    </div>
                    <div class="message-item">
                        <div class="message-item-header">
                            <span class="sender-name">이순신</span>
                            <span class="message-time">2024-10-07 11:20</span>
                        </div>
                        <div class="message-preview">어제 회의에 대해...</div>
                    </div>
                    <!-- 추가 메시지 아이템들 -->
                </div>
            </div>

            <!-- 우측 메시지 상세 패널 -->
            <div class="message-detail-panel">
                <div class="message-detail-header">
                    <h2>메세지 상세보기</h2>
                </div>
                <div class="message-detail-content">
                    <!-- 선택된 메시지 내용이 여기에 표시됩니다 -->
                </div>

                <form id="messageForm" method="POST" onsubmit="return validateAndSubmit()">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                    <input type="hidden" id="recipientsInput" name="recipients" />
                    <div class="message-compose">
                        <div class="compose-header">
                            <div class="recipient-container"></div>
                            <button class="search-recipient-btn" onclick="openRecipientModal(event)">받는 사람 검색</button>
                        </div>
                        <input type="text" class="message-input" id="titleInput" name="title"  placeholder="메시지 제목을 입력하세요..."/>
                        <textarea class="message-input" placeholder="메시지를 입력하세요..."></textarea>
                        <button class="send-button">보내기</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- 사용자 검색 모달 -->
        <div id="recipientModal" class="modal">
            <div class="modal-content">
                <h4>받는 사람 검색</h4>
                <div class="mb-3">
                    <input type="text" class="form-control" id="searchInput" placeholder="검색어를 입력하세요">
                </div>
                <div id="searchResults">
                    <table class="table">
                        <thead>
                        <tr>
                            <th>번호</th>
                            <th>이름</th>
                            <th>선택</th>
                        </tr>
                        </thead>
                        <tbody id="recipientList"></tbody>
                    </table>
                    <div class="no-results" style="display: none;">사용자가 없습니다.</div>
                    <nav>
                        <ul class="pagination">
                            <li class="page-item active"><a class="page-link" href="#">1</a></li>
                        </ul>
                    </nav>
                </div>
                <div class="text-end mt-3">
                    <button class="btn btn-secondary" onclick="closeRecipientModal()">닫기</button>
                </div>
            </div>
        </div>

    <!-- 새 메시지 알림 -->
        <div class="notification">
            새로운 메시지가 도착했습니다.
        </div>

    </div>
</body>
</html>
