<!DOCTYPE html>
<html layout:decorate="~{global/usrLayout}">

<head>
    <meta charset="UTF-8">
    <link rel="icon" href="https://static.toss.im/icons/png/4x/icon-toss-logo.png"/>
    <link rel="stylesheet" type="text/css" href="/resource/global/style.css"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title th:text="|토스페이먼츠 결제하기|"></title>
    <script type="text/javascript">
        //쿼리 파라미터 값이 결제 요청할 때 보낸 데이터와 동일한지 반드시 확인할것
        //클라이언트에서 결제 금액을 조작하는 행위를 방지할수 있다.
        const urlParams = new URLSearchParams(window.location.search);

        //서버로 결제 승인에 필요한 결제 정보를 보내기.
        async function confirm() {
            var requestData = {
                paymentKey: urlParams.get("paymentKey"),
                orderId: urlParams.get("orderId"),
                amount: urlParams.get("amount"),
            };
            const response = await fetch("/api/v1/payments/confirm", {
                method: "POST",
                headers: {
                    "Content-Type": "applicaiton/json",
                },
                body: JSON.stringify(requestData),
            });

            const json = await response.json();
            if (!response.ok) {
                //TODO: 결제 실패 비즈니스 로직을 구현
                console.log(json);
                window.location.href = `/payments/fail?message=${json.message}&code=${json.code}`;
            }

            //TODO: 결제 성공 비즈니스 로직을 구현하기.
            console.log(json);
        };

        confirm();


        const paymentKeyElement = document.getElementById("paymentKey");
        const orderIdElement = document.getElementById("orderId");
        const amountElement = document.getElementById("amount");

        orderIdElement.textContent = "주문번호: "+urlParams.get("orderId");
        amountElement.textContent="결제 금액: "+urlParams.get("amount");
        paymentKeyElement.textContent="paymentKey: "+urlParams.get("paymentKey");
    </script>
</head>
<body>
    <div layout:fragment="content">
        <div class="result wrapper">
            <div class="box_section">
                <h2 style="padding: 20px 0px 10px 0px">
                    <img width="35px" src="https://static.toss.im/3d-emojis/u1F389_apng.png"/>
                    결제 성공
                </h2>
                <p id="paymentKey"></p>
                <p id="orderId"></p>
                <p id="amount"></p>
            </div>
        </div>
    </div>
</body>
</html>